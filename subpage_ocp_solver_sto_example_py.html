<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.5"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>robotoc: Switching time optimization (STO) example of robotoc::OCPSolver in Python</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">robotoc
   </div>
   <div id="projectbrief">robotoc - efficient ROBOT Optimal Control solvers</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.5 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('subpage_ocp_solver_sto_example_py.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Switching time optimization (STO) example of <a class="el" href="classrobotoc_1_1_o_c_p_solver.html" title="Optimal control problem solver by Riccati recursion.">robotoc::OCPSolver</a> in Python </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p >This page explains the example code in examples/anymal/python/jump_sto.py.</p>
<p ><img src="https://raw.githubusercontent.com/wiki/mayataka/robotoc/images/jumping_sto.gif" alt="" width="350" class="inline"/></p>
<p >Required imports are as follows. </p><div class="fragment"><div class="line"><span class="keyword">import</span> <a class="code hl_namespace" href="namespacerobotoc.html">robotoc</a></div>
<div class="line"><span class="keyword">import</span> numpy as np</div>
<div class="line"><span class="keyword">import</span> math</div>
<div class="ttc" id="anamespacerobotoc_html"><div class="ttname"><a href="namespacerobotoc.html">robotoc</a></div><div class="ttdef"><b>Definition:</b> constraint_component_base.hpp:17</div></div>
</div><!-- fragment --><p >First, we define the robot model. We speficy the URDF path, base joint type, and contact frames (in this case, the contact frames are the frames of all feet). </p><div class="fragment"><div class="line">model_info = <a class="code hl_namespace" href="namespacerobotoc.html">robotoc</a>.<a class="code hl_class" href="structrobotoc_1_1_robot_model_info.html">RobotModelInfo</a>()</div>
<div class="line">model_info.<a class="code hl_variable" href="structrobotoc_1_1_robot_model_info.html#ac3e41b1ec17b2266d833dccb5af954ad">urdf_path</a> = <span class="stringliteral">&#39;../anymal_b_simple_description/urdf/anymal.urdf&#39;</span></div>
<div class="line">model_info.base_joint_type = <a class="code hl_namespace" href="namespacerobotoc.html">robotoc</a>.BaseJointType.FloatingBase</div>
<div class="line">baumgarte_time_step = 0.05</div>
<div class="line">model_info.point_contacts = [<a class="code hl_namespace" href="namespacerobotoc.html">robotoc</a>.<a class="code hl_class" href="structrobotoc_1_1_contact_model_info.html">ContactModelInfo</a>(<span class="stringliteral">&#39;LF_FOOT&#39;</span>, baumgarte_time_step),</div>
<div class="line">                             <a class="code hl_namespace" href="namespacerobotoc.html">robotoc</a>.<a class="code hl_class" href="structrobotoc_1_1_contact_model_info.html">ContactModelInfo</a>(<span class="stringliteral">&#39;LH_FOOT&#39;</span>, baumgarte_time_step),</div>
<div class="line">                             <a class="code hl_namespace" href="namespacerobotoc.html">robotoc</a>.<a class="code hl_class" href="structrobotoc_1_1_contact_model_info.html">ContactModelInfo</a>(<span class="stringliteral">&#39;RF_FOOT&#39;</span>, baumgarte_time_step),</div>
<div class="line">                             <a class="code hl_namespace" href="namespacerobotoc.html">robotoc</a>.<a class="code hl_class" href="structrobotoc_1_1_contact_model_info.html">ContactModelInfo</a>(<span class="stringliteral">&#39;RH_FOOT&#39;</span>, baumgarte_time_step)]</div>
<div class="line">robot = <a class="code hl_namespace" href="namespacerobotoc.html">robotoc</a>.<a class="code hl_class" href="classrobotoc_1_1_robot.html">Robot</a>(model_info)</div>
<div class="ttc" id="aclassrobotoc_1_1_robot_html"><div class="ttname"><a href="classrobotoc_1_1_robot.html">robotoc::Robot</a></div><div class="ttdoc">Dynamics and kinematics model of robots. Wraps pinocchio::Model and pinocchio::Data....</div><div class="ttdef"><b>Definition:</b> robot.hpp:32</div></div>
<div class="ttc" id="astructrobotoc_1_1_contact_model_info_html"><div class="ttname"><a href="structrobotoc_1_1_contact_model_info.html">robotoc::ContactModelInfo</a></div><div class="ttdoc">Info of a contact model.</div><div class="ttdef"><b>Definition:</b> contact_model_info.hpp:12</div></div>
<div class="ttc" id="astructrobotoc_1_1_robot_model_info_html"><div class="ttname"><a href="structrobotoc_1_1_robot_model_info.html">robotoc::RobotModelInfo</a></div><div class="ttdoc">Info of a robot model.</div><div class="ttdef"><b>Definition:</b> robot_model_info.hpp:24</div></div>
<div class="ttc" id="astructrobotoc_1_1_robot_model_info_html_ac3e41b1ec17b2266d833dccb5af954ad"><div class="ttname"><a href="structrobotoc_1_1_robot_model_info.html#ac3e41b1ec17b2266d833dccb5af954ad">robotoc::RobotModelInfo::urdf_path</a></div><div class="ttdeci">std::string urdf_path</div><div class="ttdoc">Path to the URDF file.</div><div class="ttdef"><b>Definition:</b> robot_model_info.hpp:73</div></div>
</div><!-- fragment --> <dl class="section note"><dt>Note</dt><dd><code>baumgarte_time_step</code> is the stabilization parameter for acceleration-level rigid contact constraints. The best choice of <code>baumgarte_time_step</code> may be the time step of the optimal control problem. However, it is often too small to make the optimization problem high nonlinear. A moderate value such as several times of the time step of optimal control problem may be sufficient</dd></dl>
<p>Then set the parameters for the optimal control problem of the jump motion such as the jump length </p><div class="fragment"><div class="line">dt = 0.02</div>
<div class="line">jump_length = np.array([0.8, 0, 0])</div>
<div class="line">flying_up_time = 0.15</div>
<div class="line">flying_down_time = flying_up_time</div>
<div class="line">flying_time = flying_up_time + flying_down_time</div>
<div class="line">ground_time = 0.7</div>
<div class="line">t0 = 0.</div>
</div><!-- fragment --><p >Next, we construct the cost function. The below is the simple quadratic cost for the optimization variables. </p><div class="fragment"><div class="line">cost = <a class="code hl_namespace" href="namespacerobotoc.html">robotoc</a>.<a class="code hl_class" href="classrobotoc_1_1_cost_function.html">CostFunction</a>()</div>
<div class="line">q_standing = np.array([0., 0., 0.4792, 0., 0., 0., 1.0, </div>
<div class="line">                       -0.1,  0.7, -1.0, </div>
<div class="line">                       -0.1, -0.7,  1.0, </div>
<div class="line">                        0.1,  0.7, -1.0, </div>
<div class="line">                        0.1, -0.7,  1.0])</div>
<div class="line">q_ref = q_standing.copy()</div>
<div class="line">q_ref[0] += jump_length</div>
<div class="line">q_weight = np.array([1.0, 0., 0., 1.0, 1.0, 1.0, </div>
<div class="line">                     0.001, 0.001, 0.001, </div>
<div class="line">                     0.001, 0.001, 0.001,</div>
<div class="line">                     0.001, 0.001, 0.001,</div>
<div class="line">                     0.001, 0.001, 0.001])</div>
<div class="line">v_weight = np.full(robot.dimv(), 1.0)</div>
<div class="line">a_weight = np.full(robot.dimv(), 1.0e-06)</div>
<div class="line">q_weight_impact = np.array([0., 0., 0., 100., 100., 100., </div>
<div class="line">                      0.1, 0.1, 0.1, </div>
<div class="line">                      0.1, 0.1, 0.1,</div>
<div class="line">                      0.1, 0.1, 0.1,</div>
<div class="line">                      0.1, 0.1, 0.1])</div>
<div class="line">v_weight_impact = np.full(robot.dimv(), 1.0)</div>
<div class="line">dv_weight_impact = np.full(robot.dimv(), 1.0e-06)</div>
<div class="line">config_cost = <a class="code hl_namespace" href="namespacerobotoc.html">robotoc</a>.<a class="code hl_class" href="classrobotoc_1_1_configuration_space_cost.html">ConfigurationSpaceCost</a>(robot)</div>
<div class="line">config_cost.<a class="code hl_function" href="classrobotoc_1_1_configuration_space_cost.html#afa373dc351bae4669bc81205c55b5e15">set_q_ref</a>(q_ref)</div>
<div class="line">config_cost.set_q_weight(q_weight)</div>
<div class="line">config_cost.set_q_weight_terminal(q_weight)</div>
<div class="line">config_cost.set_q_weight_impact(q_weight_impact)</div>
<div class="line">config_cost.set_v_weight(v_weight)</div>
<div class="line">config_cost.set_v_weight_terminal(v_weight)</div>
<div class="line">config_cost.set_v_weight_impact(v_weight_impact)</div>
<div class="line">config_cost.set_dv_weight_impact(dv_weight_impact)</div>
<div class="line">config_cost.set_a_weight(a_weight)</div>
<div class="line">cost.add(<span class="stringliteral">&quot;config_cost&quot;</span>, config_cost)</div>
<div class="ttc" id="aclassrobotoc_1_1_configuration_space_cost_html"><div class="ttname"><a href="classrobotoc_1_1_configuration_space_cost.html">robotoc::ConfigurationSpaceCost</a></div><div class="ttdoc">Configuration space cost.</div><div class="ttdef"><b>Definition:</b> configuration_space_cost.hpp:23</div></div>
<div class="ttc" id="aclassrobotoc_1_1_configuration_space_cost_html_afa373dc351bae4669bc81205c55b5e15"><div class="ttname"><a href="classrobotoc_1_1_configuration_space_cost.html#afa373dc351bae4669bc81205c55b5e15">robotoc::ConfigurationSpaceCost::set_q_ref</a></div><div class="ttdeci">void set_q_ref(const Eigen::VectorXd &amp;q_ref)</div><div class="ttdoc">Sets the const reference configuration q.</div></div>
<div class="ttc" id="aclassrobotoc_1_1_cost_function_html"><div class="ttname"><a href="classrobotoc_1_1_cost_function.html">robotoc::CostFunction</a></div><div class="ttdoc">Stack of the cost function. Composed by cost function components that inherits CostFunctionComponentB...</div><div class="ttdef"><b>Definition:</b> cost_function.hpp:30</div></div>
</div><!-- fragment --><p >Next, we construct the constraints. </p><div class="fragment"><div class="line">constraints           = <a class="code hl_namespace" href="namespacerobotoc.html">robotoc</a>.<a class="code hl_class" href="classrobotoc_1_1_constraints.html">Constraints</a>(barrier_param=1.0e-03, fraction_to_boundary_rule=0.995)</div>
<div class="line">joint_position_lower  = <a class="code hl_namespace" href="namespacerobotoc.html">robotoc</a>.<a class="code hl_class" href="classrobotoc_1_1_joint_position_lower_limit.html">JointPositionLowerLimit</a>(robot)</div>
<div class="line">joint_position_upper  = <a class="code hl_namespace" href="namespacerobotoc.html">robotoc</a>.<a class="code hl_class" href="classrobotoc_1_1_joint_position_upper_limit.html">JointPositionUpperLimit</a>(robot)</div>
<div class="line">joint_velocity_lower  = <a class="code hl_namespace" href="namespacerobotoc.html">robotoc</a>.<a class="code hl_class" href="classrobotoc_1_1_joint_velocity_lower_limit.html">JointVelocityLowerLimit</a>(robot)</div>
<div class="line">joint_velocity_upper  = <a class="code hl_namespace" href="namespacerobotoc.html">robotoc</a>.<a class="code hl_class" href="classrobotoc_1_1_joint_velocity_upper_limit.html">JointVelocityUpperLimit</a>(robot)</div>
<div class="line">joint_torques_lower   = <a class="code hl_namespace" href="namespacerobotoc.html">robotoc</a>.<a class="code hl_class" href="classrobotoc_1_1_joint_torques_lower_limit.html">JointTorquesLowerLimit</a>(robot)</div>
<div class="line">joint_torques_upper   = <a class="code hl_namespace" href="namespacerobotoc.html">robotoc</a>.<a class="code hl_class" href="classrobotoc_1_1_joint_torques_upper_limit.html">JointTorquesUpperLimit</a>(robot)</div>
<div class="line">friction_cone         = <a class="code hl_namespace" href="namespacerobotoc.html">robotoc</a>.<a class="code hl_class" href="classrobotoc_1_1_friction_cone.html">FrictionCone</a>(robot)</div>
<div class="line">constraints.add(<span class="stringliteral">&quot;joint_position_lower&quot;</span>, joint_position_lower)</div>
<div class="line">constraints.add(<span class="stringliteral">&quot;joint_position_upper&quot;</span>, joint_position_upper)</div>
<div class="line">constraints.add(<span class="stringliteral">&quot;joint_velocity_lower&quot;</span>, joint_velocity_lower)</div>
<div class="line">constraints.add(<span class="stringliteral">&quot;joint_velocity_upper&quot;</span>, joint_velocity_upper)</div>
<div class="line">constraints.add(<span class="stringliteral">&quot;joint_torques_lower&quot;</span>, joint_torques_lower)</div>
<div class="line">constraints.add(<span class="stringliteral">&quot;joint_torques_upper&quot;</span>, joint_torques_upper)</div>
<div class="line">constraints.add(<span class="stringliteral">&quot;friction_cone&quot;</span>, friction_cone)</div>
<div class="ttc" id="aclassrobotoc_1_1_constraints_html"><div class="ttname"><a href="classrobotoc_1_1_constraints.html">robotoc::Constraints</a></div><div class="ttdoc">Stack of the inequality constraints. Composed by constraint components that inherits ConstraintCompon...</div><div class="ttdef"><b>Definition:</b> constraints.hpp:30</div></div>
<div class="ttc" id="aclassrobotoc_1_1_friction_cone_html"><div class="ttname"><a href="classrobotoc_1_1_friction_cone.html">robotoc::FrictionCone</a></div><div class="ttdoc">Constraint on the inner-approximated firction cone.</div><div class="ttdef"><b>Definition:</b> friction_cone.hpp:22</div></div>
<div class="ttc" id="aclassrobotoc_1_1_joint_position_lower_limit_html"><div class="ttname"><a href="classrobotoc_1_1_joint_position_lower_limit.html">robotoc::JointPositionLowerLimit</a></div><div class="ttdoc">Constraint on the lower limits of the joint position.</div><div class="ttdef"><b>Definition:</b> joint_position_lower_limit.hpp:22</div></div>
<div class="ttc" id="aclassrobotoc_1_1_joint_position_upper_limit_html"><div class="ttname"><a href="classrobotoc_1_1_joint_position_upper_limit.html">robotoc::JointPositionUpperLimit</a></div><div class="ttdoc">Constraint on the upper limits of the joint position.</div><div class="ttdef"><b>Definition:</b> joint_position_upper_limit.hpp:22</div></div>
<div class="ttc" id="aclassrobotoc_1_1_joint_torques_lower_limit_html"><div class="ttname"><a href="classrobotoc_1_1_joint_torques_lower_limit.html">robotoc::JointTorquesLowerLimit</a></div><div class="ttdoc">Constraint on the lower limits of the joint torques.</div><div class="ttdef"><b>Definition:</b> joint_torques_lower_limit.hpp:22</div></div>
<div class="ttc" id="aclassrobotoc_1_1_joint_torques_upper_limit_html"><div class="ttname"><a href="classrobotoc_1_1_joint_torques_upper_limit.html">robotoc::JointTorquesUpperLimit</a></div><div class="ttdoc">Constraint on the upper limits of the joint torques.</div><div class="ttdef"><b>Definition:</b> joint_torques_upper_limit.hpp:22</div></div>
<div class="ttc" id="aclassrobotoc_1_1_joint_velocity_lower_limit_html"><div class="ttname"><a href="classrobotoc_1_1_joint_velocity_lower_limit.html">robotoc::JointVelocityLowerLimit</a></div><div class="ttdoc">Constraint on the lower limits of the joint velocity.</div><div class="ttdef"><b>Definition:</b> joint_velocity_lower_limit.hpp:22</div></div>
<div class="ttc" id="aclassrobotoc_1_1_joint_velocity_upper_limit_html"><div class="ttname"><a href="classrobotoc_1_1_joint_velocity_upper_limit.html">robotoc::JointVelocityUpperLimit</a></div><div class="ttdoc">Constraint on the upper limits of the joint velocity.</div><div class="ttdef"><b>Definition:</b> joint_velocity_upper_limit.hpp:22</div></div>
</div><!-- fragment --><p >Next, we construct the contact sequence <code><a class="el" href="classrobotoc_1_1_contact_sequence.html" title="The sequence of contact status and discrete events (impact and lift).">robotoc::ContactSequence</a></code> as </p><div class="fragment"><div class="line">contact_sequence = <a class="code hl_namespace" href="namespacerobotoc.html">robotoc</a>.<a class="code hl_class" href="classrobotoc_1_1_contact_sequence.html">ContactSequence</a>(robot)</div>
<div class="ttc" id="aclassrobotoc_1_1_contact_sequence_html"><div class="ttname"><a href="classrobotoc_1_1_contact_sequence.html">robotoc::ContactSequence</a></div><div class="ttdoc">The sequence of contact status and discrete events (impact and lift).</div><div class="ttdef"><b>Definition:</b> contact_sequence.hpp:23</div></div>
</div><!-- fragment --><p> Then we can set an impact event and a lift event to the contact sequence.</p>
<p >We set the contact positions and friction coefficients through the contact sequence. We then define the friction coefficients. </p><div class="fragment"><div class="line">mu = 0.7</div>
<div class="line">friction_coefficients = {<span class="stringliteral">&#39;LF_FOOT&#39;</span>: mu, <span class="stringliteral">&#39;LH_FOOT&#39;</span>: mu, <span class="stringliteral">&#39;RF_FOOT&#39;</span>: mu, <span class="stringliteral">&#39;RH_FOOT&#39;</span>: mu} </div>
</div><!-- fragment --><p >We set the initial contact status of the robot. In the beginning, the robot is standing, so all the contacts are active. </p><div class="fragment"><div class="line">robot.forward_kinematics(q_standing)</div>
<div class="line">x3d0_LF = robot.frame_position(<span class="stringliteral">&#39;LF_FOOT&#39;</span>)</div>
<div class="line">x3d0_LH = robot.frame_position(<span class="stringliteral">&#39;LH_FOOT&#39;</span>)</div>
<div class="line">x3d0_RF = robot.frame_position(<span class="stringliteral">&#39;RF_FOOT&#39;</span>)</div>
<div class="line">x3d0_RH = robot.frame_position(<span class="stringliteral">&#39;RH_FOOT&#39;</span>)</div>
<div class="line">contact_positions = {<span class="stringliteral">&#39;LF_FOOT&#39;</span>: x3d0_LF, <span class="stringliteral">&#39;LH_FOOT&#39;</span>: x3d0_LH, <span class="stringliteral">&#39;RF_FOOT&#39;</span>: x3d0_RF, <span class="stringliteral">&#39;RH_FOOT&#39;</span>: x3d0_RH} </div>
<div class="line"> </div>
<div class="line">contact_status_standing = robot.create_contact_status()</div>
<div class="line">contact_status_standing.activate_contacts([<span class="stringliteral">&#39;LF_FOOT&#39;</span>, <span class="stringliteral">&#39;LH_FOOT&#39;</span>, <span class="stringliteral">&#39;RF_FOOT&#39;</span>, <span class="stringliteral">&#39;RH_FOOT&#39;</span>])</div>
<div class="line">contact_status_standing.set_contact_placements(contact_positions)</div>
<div class="line">contact_status_standing.set_friction_coefficients(friction_coefficients)</div>
<div class="line">contact_sequence.init(contact_status_standing)</div>
</div><!-- fragment --><p >Next, we set the contact status when the robot is flying. Then the all the contacts are inactive. </p><div class="fragment"><div class="line">contact_status_flying = robot.create_contact_status()</div>
<div class="line">contact_sequence.push_back(contact_status_flying, t0+ground_time-0.3, sto=True)</div>
</div><!-- fragment --><p> Then a lift event is automatically appended into the contact sequence. By setting <code>sto=True</code>, the switching time of this event is regarded as an optimization variable. Finally, we set the contact status after touch-down as </p><div class="fragment"><div class="line">contact_positions[<span class="stringliteral">&#39;LF_FOOT&#39;</span>] += jump_length</div>
<div class="line">contact_positions[<span class="stringliteral">&#39;LH_FOOT&#39;</span>] += jump_length</div>
<div class="line">contact_positions[<span class="stringliteral">&#39;RF_FOOT&#39;</span>] += jump_length</div>
<div class="line">contact_positions[<span class="stringliteral">&#39;RH_FOOT&#39;</span>] += jump_length</div>
<div class="line">contact_status_standing.set_contact_placements(contact_positions)</div>
<div class="line">contact_sequence.push_back(contact_status_standing, t0+ground_time+flying_time-0.1, sto=True)</div>
</div><!-- fragment --><p> Then an impact event is automatically appended into the contact sequence.</p>
<dl class="section note"><dt>Note</dt><dd>We can check the contact sequence via <div class="fragment"><div class="line">print(contact_sequence)</div>
</div><!-- fragment --></dd></dl>
<p>We further construct cost function for the switching time optimization (STO) problem </p><div class="fragment"><div class="line">sto_cost = <a class="code hl_namespace" href="namespacerobotoc.html">robotoc</a>.<a class="code hl_class" href="classrobotoc_1_1_s_t_o_cost_function.html">STOCostFunction</a>()</div>
<div class="ttc" id="aclassrobotoc_1_1_s_t_o_cost_function_html"><div class="ttname"><a href="classrobotoc_1_1_s_t_o_cost_function.html">robotoc::STOCostFunction</a></div><div class="ttdoc">Stack of the cost function of the switching time optimization (STO) problem. Composed by cost functio...</div><div class="ttdef"><b>Definition:</b> sto_cost_function.hpp:24</div></div>
</div><!-- fragment --><p> and the minimum dwell-time constraints for the STO problem </p><div class="fragment"><div class="line">sto_constraints = <a class="code hl_namespace" href="namespacerobotoc.html">robotoc</a>.<a class="code hl_class" href="classrobotoc_1_1_s_t_o_constraints.html">STOConstraints</a>(minimum_dwell_times=[0.15, 0.15, 0.65],</div>
<div class="line">                                         barrier_param=1.0e-03, </div>
<div class="line">                                         fraction_to_boundary_rule=0.995)</div>
<div class="ttc" id="aclassrobotoc_1_1_s_t_o_constraints_html"><div class="ttname"><a href="classrobotoc_1_1_s_t_o_constraints.html">robotoc::STOConstraints</a></div><div class="ttdoc">Constraints of the switching time optimization problems.</div><div class="ttdef"><b>Definition:</b> sto_constraints.hpp:23</div></div>
</div><!-- fragment --><p >Finally, we can construct the optimal control solver! </p><div class="fragment"><div class="line">T = t0 + flying_time + 2*ground_time</div>
<div class="line">N = math.floor(T/dt) </div>
<div class="line">ocp = <a class="code hl_namespace" href="namespacerobotoc.html">robotoc</a>.<a class="code hl_class" href="structrobotoc_1_1_o_c_p.html">OCP</a>(robot=robot, contact_sequence=contact_sequence, </div>
<div class="line">                  cost=cost, constraints=constraints, </div>
<div class="line">                  sto_cost=sto_cost, sto_constraints=sto_constraints, T=T, N=N)</div>
<div class="line">solver_options = <a class="code hl_namespace" href="namespacerobotoc.html">robotoc</a>.<a class="code hl_class" href="structrobotoc_1_1_solver_options.html">SolverOptions</a>()</div>
<div class="line">solver_options.<a class="code hl_variable" href="structrobotoc_1_1_solver_options.html#aa89c11a871791dd29394cfc066dbf202">kkt_tol_mesh</a> = 0.1</div>
<div class="line">solver_options.max_dt_mesh = T/N </div>
<div class="line">solver_options.max_iter = 200</div>
<div class="line">solver_options.nthreads=4</div>
<div class="line">ocp_solver = <a class="code hl_namespace" href="namespacerobotoc.html">robotoc</a>.<a class="code hl_class" href="classrobotoc_1_1_o_c_p_solver.html">OCPSolver</a>(ocp=ocp, solver_options=solver_options)</div>
<div class="ttc" id="aclassrobotoc_1_1_o_c_p_solver_html"><div class="ttname"><a href="classrobotoc_1_1_o_c_p_solver.html">robotoc::OCPSolver</a></div><div class="ttdoc">Optimal control problem solver by Riccati recursion.</div><div class="ttdef"><b>Definition:</b> ocp_solver.hpp:41</div></div>
<div class="ttc" id="astructrobotoc_1_1_o_c_p_html"><div class="ttname"><a href="structrobotoc_1_1_o_c_p.html">robotoc::OCP</a></div><div class="ttdoc">The optimal control problem.</div><div class="ttdef"><b>Definition:</b> ocp.hpp:22</div></div>
<div class="ttc" id="astructrobotoc_1_1_solver_options_html"><div class="ttname"><a href="structrobotoc_1_1_solver_options.html">robotoc::SolverOptions</a></div><div class="ttdoc">Options of optimal control solvers.</div><div class="ttdef"><b>Definition:</b> solver_options.hpp:17</div></div>
<div class="ttc" id="astructrobotoc_1_1_solver_options_html_aa89c11a871791dd29394cfc066dbf202"><div class="ttname"><a href="structrobotoc_1_1_solver_options.html#aa89c11a871791dd29394cfc066dbf202">robotoc::SolverOptions::kkt_tol_mesh</a></div><div class="ttdeci">double kkt_tol_mesh</div><div class="ttdoc">Tolerance of the KKT residual to perform mesh-refinement in the STO problem. Default is 1....</div><div class="ttdef"><b>Definition:</b> solver_options.hpp:113</div></div>
</div><!-- fragment --> <dl class="section note"><dt>Note</dt><dd>Without <code><a class="el" href="classrobotoc_1_1_s_t_o_cost_function.html" title="Stack of the cost function of the switching time optimization (STO) problem. Composed by cost functio...">robotoc::STOCostFunction</a></code> and <code><a class="el" href="classrobotoc_1_1_s_t_o_constraints.html" title="Constraints of the switching time optimization problems.">robotoc::STOConstraints</a></code>, the solver does not optimize the switching times. Therefore, even if there are empty (e.g., the STO cost of this example is also empty), please pass them to the constructor of OCP.</dd>
<dd>
In this example, we want to optimize the switching times as well as the whole-body trajectory of the robot. Then we need to carry on mesh refinement because the switching times change over the iterations. We set <code>SolverOptions::max_dt_mesh</code> that the maximum value of the time-steps. We also set <code>SolverOptions::kkt_tol_mesh</code> and we apply the mesh refinement when the KKT error is less than <code>SolverOptions::kkt_tol_mesh</code> and the maximum time step is larger than <code>SolverOptions::max_dt_mesh</code>.</dd></dl>
<p>Let's run the solver! </p><div class="fragment"><div class="line">t = 0.</div>
<div class="line">q = q_standing # initial state.</div>
<div class="line">v = np.zeros(robot.dimv()) # initial state.</div>
<div class="line"> </div>
<div class="line">ocp_solver.discretize(t) # discretizes the optimal control problem.</div>
<div class="line">ocp_solver.setSolution(<span class="stringliteral">&quot;q&quot;</span>, q); # set the initial guess of the solution.</div>
<div class="line">ocp_solver.setSolution(<span class="stringliteral">&quot;v&quot;</span>, v); # set the initial guess of the solution.</div>
<div class="line">Eigen::Vector3d f_init;</div>
<div class="line">f_init &lt;&lt; 0, 0, 0.25*robot.totalWeight();</div>
<div class="line">ocp_solver.setSolution(<span class="stringliteral">&quot;f&quot;</span>, f_init); # set the initial guess of the solution.</div>
<div class="line"> </div>
<div class="line">ocp_solver.init_constraints() # initialize the slack and dual variables of the primal-dual interior point method.</div>
<div class="line">print(<span class="stringliteral">&quot;Initial KKT error: &quot;</span>, ocp_solver.KKT_error(t, q, v))</div>
<div class="line">ocp_solver.solve(t, q, v)</div>
<div class="line">print(<span class="stringliteral">&quot;KKT error after convergence: &quot;</span>, ocp_solver.KKT_error(t, q, v)) </div>
<div class="line">print(ocp_solver.get_solver_statistics()) <span class="preprocessor"># print solver statistics</span></div>
</div><!-- fragment --><p >We can plot the convergence and the optimal contact forces as </p><div class="fragment"><div class="line">kkt_data = ocp_solver.get_solver_statistics().kkt_error + [ocp_solver.KKT_error()] # append KKT after convergence</div>
<div class="line">ts_data = ocp_solver.get_solver_statistics().ts + [contact_sequence.event_times()] # append ts after convergence</div>
<div class="line"> </div>
<div class="line">plot_ts = <a class="code hl_namespace" href="namespacerobotoc.html">robotoc</a>.utils.PlotConvergence()</div>
<div class="line">plot_ts.ylim = [0., 1.5]</div>
<div class="line">plot_ts.plot(kkt_data=kkt_data, ts_data=ts_data, fig_name=<span class="stringliteral">&#39;jump_sto&#39;</span>, </div>
<div class="line">             save_dir=<span class="stringliteral">&#39;jump_sto_log&#39;</span>)</div>
<div class="line"> </div>
<div class="line">plot_f = <a class="code hl_namespace" href="namespacerobotoc.html">robotoc</a>.utils.PlotContactForce(mu=mu)</div>
<div class="line">plot_f.plot(f_data=ocp_solver.get_solution(<span class="charliteral">&#39;f&#39;</span>, <span class="stringliteral">&#39;WORLD&#39;</span>), </div>
<div class="line">            t=ocp_solver.get_time_discretization().time_points(), </div>
<div class="line">            fig_name=<span class="stringliteral">&#39;jump_sto_f&#39;</span>, save_dir=<span class="stringliteral">&#39;jump_sto_log&#39;</span>)</div>
</div><!-- fragment --><p> Then we obtain the convergence results ((left) switching times and (right) KKT error at each iteration)</p>
<p ><img src="https://raw.githubusercontent.com/wiki/mayataka/robotoc/images/jumping_sto.png" alt="" width="400" class="inline"/></p>
<p >and the solution trajectory of the contact forces</p>
<p ><img src="https://raw.githubusercontent.com/wiki/mayataka/robotoc/images/jumping_sto_f.png" alt="" width="400" class="inline"/></p>
<p >where the grey hatches indicates the infeasible regions of fx and fy due to the friction cone constraints. We can see that the solution strictly satisfies the friction cone constraints.</p>
<p >We can also visualize the solution trajectory as </p><div class="fragment"><div class="line">viewer = <a class="code hl_namespace" href="namespacerobotoc.html">robotoc</a>.utils.TrajectoryViewer(path_to_urdf=path_to_urdf, </div>
<div class="line">                                        base_joint_type=<a class="code hl_namespace" href="namespacerobotoc.html">robotoc</a>.BaseJointType.FloatingBase,</div>
<div class="line">                                        viewer_type=<span class="stringliteral">&#39;gepetto&#39;</span>)</div>
<div class="line">viewer.set_contact_info(robot.contact_frames(), mu)</div>
<div class="line">viewer.display(ocp_solver.get_time_discretization().time_steps(), </div>
<div class="line">               ocp_solver.get_solution(<span class="charliteral">&#39;q&#39;</span>), </div>
<div class="line">               ocp_solver.get_solution(<span class="charliteral">&#39;f&#39;</span>, <span class="stringliteral">&#39;WORLD&#39;</span>))</div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd>We can check the discretization of the optimal control problem sololy via <div class="fragment"><div class="line">time_discretization = <a class="code hl_namespace" href="namespacerobotoc.html">robotoc</a>.<a class="code hl_class" href="classrobotoc_1_1_time_discretization.html">TimeDiscretization</a>(T, N)</div>
<div class="line">time_discretization.<a class="code hl_function" href="classrobotoc_1_1_time_discretization.html#ade7959b9a70c3f61a010d89fbf501133">discretize</a>(contact_sequence, t)</div>
<div class="line">print(time_discretization)</div>
<div class="ttc" id="aclassrobotoc_1_1_time_discretization_html"><div class="ttname"><a href="classrobotoc_1_1_time_discretization.html">robotoc::TimeDiscretization</a></div><div class="ttdoc">Time discretization of the optimal control problem.</div><div class="ttdef"><b>Definition:</b> time_discretization.hpp:20</div></div>
<div class="ttc" id="aclassrobotoc_1_1_time_discretization_html_ade7959b9a70c3f61a010d89fbf501133"><div class="ttname"><a href="classrobotoc_1_1_time_discretization.html#ade7959b9a70c3f61a010d89fbf501133">robotoc::TimeDiscretization::discretize</a></div><div class="ttdeci">void discretize(const std::shared_ptr&lt; ContactSequence &gt; &amp;contact_sequence, const double t)</div><div class="ttdoc">Discretizes the finite horizon taking into account the discrete events.</div></div>
</div><!-- fragment --> </dd></dl>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="page_examples.html">Examples</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.5 </li>
  </ul>
</div>
</body>
</html>
